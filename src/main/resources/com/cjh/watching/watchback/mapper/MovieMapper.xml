<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.cjh.watching.watchback.mapper.MovieMapper">
    <select id="getAllData" resultType="com.cjh.watching.watchback.dto.MovieDto">
        SELECT
            id,
             tmdb_id,
             title,
             original_language,
             overview,
             vote_average,
             vote_count,
             popularity,
             poster_path,
             backdrop_path,
             media_type,
             genre_ids
        FROM (
                 SELECT
                     movie_id as id,
                     tmdb_id,
                     title,
                     original_language,
                     overview,
                     vote_average,
                     vote_count,
                     popularity,
                     poster_path,
                     backdrop_path,
                     1 as media_type,
                     genre_ids
                 FROM movies
                <where>
                    <if test="query.query!=null and query.query !=''">
                        and title LIKE CONCAT('%',#{query.query},'%')
                    </if>
                </where>
                 UNION ALL
                 SELECT
                     show_id as id,
                     tmdb_id,
                     name as title,
                     original_language,
                     overview,
                     vote_average,
                     vote_count,
                     popularity,
                     poster_path,
                     backdrop_path,
                     2 as media_type,
                     genre_ids
                 FROM tv_shows
                <where>
                    <if test="query.query!=null and query.query !=''">
                        and name LIKE CONCAT('%',#{query.query},'%')
                    </if>
                </where>
             ) t
            ORDER BY RAND()
    </select>

    <select id="getAllDataBySearch" resultType="com.cjh.watching.watchback.dto.MovieDto">
        SELECT
            id,
             tmdb_id,
             title,
             original_language,
             overview,
             vote_average,
             vote_count,
             popularity,
             poster_path,
             backdrop_path,
             media_type,
             genre_ids
        FROM (
                 SELECT
                     movie_id as id,
                     tmdb_id,
                     title,
                     original_language,
                     overview,
                     vote_average,
                     vote_count,
                     popularity,
                     poster_path,
                     backdrop_path,
                     1 as media_type,
                     genre_ids
                 FROM movies
                 <where>
                     <if test="query!=null and query !=''">
                         and title LIKE CONCAT('%',#{query},'%')
                     </if>
                 </where>
                 UNION ALL
                 SELECT
                     show_id as id,
                     tmdb_id,
                     name as title,
                     original_language,
                     overview,
                     vote_average,
                     vote_count,
                     popularity,
                     poster_path,
                     backdrop_path,
                     2 as media_type,
                     genre_ids
                 FROM tv_shows
                <where>
                    <if test="query!=null and query !=''">
                        and name LIKE CONCAT('%',#{query},'%')
                    </if>
                </where>
             ) t
            limit 10
    </select>
    
    <!-- 精确匹配电影标题 -->
    <select id="findMoviesByExactTitles" resultType="com.cjh.watching.watchback.entity.Movie">
        SELECT *
        FROM movies
        WHERE title IN
        <foreach item="title" collection="titles" open="(" separator="," close=")">
            #{title}
        </foreach>
        OR original_title IN
        <foreach item="title" collection="titles" open="(" separator="," close=")">
            #{title}
        </foreach>
    </select>
    
    <!-- 模糊匹配电影标题 -->
    <select id="findMoviesByFuzzyTitle" resultType="com.cjh.watching.watchback.entity.Movie">
        SELECT *
        FROM movies
        WHERE title LIKE CONCAT('%', #{title}, '%')
           OR original_title LIKE CONCAT('%', #{title}, '%')
        ORDER BY
            CASE
                WHEN title = #{title} OR original_title = #{title} THEN 1
                WHEN title LIKE CONCAT(#{title}, '%') OR original_title LIKE CONCAT(#{title}, '%') THEN 2
                WHEN title LIKE CONCAT('%', #{title}) OR original_title LIKE CONCAT('%', #{title}) THEN 3
                ELSE 4
            END,
            LENGTH(title) ASC
        LIMIT 10
    </select>
    
    <!-- 查询用户对电影的收藏状态 -->
    <select id="getUserMovieCollectionStatuses" resultType="java.lang.Integer">
        SELECT status
        FROM user_media_collection
        WHERE user_id = #{userId}
          AND media_type = 1
          AND media_id = #{mediaId}
        ORDER BY status ASC
    </select>
</mapper>
